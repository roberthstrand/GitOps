name: Pull Request
on: pull_request

defaults:
  run:
    working-directory: terraform

jobs:
  tflint:
    name: tflint
    runs-on: ubuntu-latest
    container: wata727/tflint
    steps:
    - uses: actions/checkout@v2
    - run: tflint

  terraform_fmt:
    name: terraform fmt
    runs-on: ubuntu-latest
    needs: tflint
    steps:
    - uses: actions/checkout@v2
    - uses: hashicorp/setup-terraform@v1
    - run: terraform fmt -check -recursive

  terraform_plan:
    name: terraform plan
    runs-on: ubuntu-latest
    needs: terraform_fmt
    environment: prod
    steps:
    - uses: actions/checkout@v2
    - uses: hashicorp/setup-terraform@v1
    - name: Terraform initiate
      run: terraform init
    - name: Terraform plan
      run: terraform plan -var-file="env/${{ github.base_ref }}.tfvars" -out=terraform.plan
    - name: Upload plan to artifact
      uses: actions/upload-artifact@v2
      with:
        name: plan
        path: terraform.plan

  checkov:
    name: Running Checkov
    runs-on: ubuntu-latest
    environment: prod
    needs: terraform_plan
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.8
        uses: actions/setup-python@v1
        with:
          python-version: 3.8
      - uses: actions/download-artifact@v2
        with:
          name: plan
      - name: Test with Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          framework: terraform